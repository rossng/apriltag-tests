---
import Layout from '../layouts/Layout.astro';
import SummaryGrid from '../components/SummaryGrid.astro';
import ImageSection from '../components/ImageSection.astro';
import { loadAllData, toSerializableResult, toSerializableSummary, discoverDetectors } from '../lib/data';
import type { SerializableSummary, SerializableImageResult } from '../lib/types';

// Get configuration from environment variables
const groundTruthDir = import.meta.env.GROUND_TRUTH_DIR || '../../ground-truth';
const resultsDir = import.meta.env.RESULTS_DIR || '../../results';

// Auto-discover detectors from results directory, or use env var if specified
const detectorsEnv = import.meta.env.DETECTORS;
const detectorNames = detectorsEnv
  ? detectorsEnv.split(',').map((s: string) => s.trim())
  : discoverDetectors(resultsDir);

// Load all data at build time
const { results, summaries, rawDetections } = loadAllData(groundTruthDir, resultsDir, detectorNames);

// Convert to serializable format for the page
const serializableSummaries: Record<string, SerializableSummary> = {};
for (const [name, summary] of summaries) {
  serializableSummaries[name] = toSerializableSummary(summary);
}

const serializableResults: SerializableImageResult[] = [];
for (const [imageName, result] of Array.from(results.entries()).sort()) {
  const raw = rawDetections.get(imageName);
  if (raw) {
    serializableResults.push(toSerializableResult(result, raw));
  }
}
---

<Layout title="AprilTag Detector Comparison Report">
  <h1>AprilTag Detector Comparison Report</h1>
  <p>Comparison of detector performance against ground truth annotations.</p>

  <h2>Summary Statistics</h2>
  <SummaryGrid summaries={serializableSummaries} detectorNames={detectorNames} />

  <h2>Per-Image Results</h2>
  {serializableResults.map((result) => (
    <ImageSection result={result} detectorNames={detectorNames} />
  ))}
</Layout>
